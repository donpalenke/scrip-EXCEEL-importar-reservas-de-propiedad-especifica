Sub ObtenerReservasBeds24()
    Dim http As Object
    Dim url As String
    Dim apiKey As String
    Dim propKey As String
    Dim response As String
    Dim json As Object
    Dim i As Integer
    Dim ws As Worksheet
    Dim headers As Variant
    Dim fromDate As String
    Dim toDate As String

    ' Configura tu API Key y Prop Key
    apiKey = "abcdef1234567890" ' Reemplaza con tu API Key
    propKey = "propkey1234567890" ' Reemplaza con tu Prop Key

    ' Configura las fechas (formato: YYYY-MM-DD)
    fromDate = "2024-04-01" ' Fecha de inicio
    toDate = "" ' Fecha futura, se deja en blanco para incluir todas las reservas futuras

    url = "https://api.beds24.com/json/getBookings"

    ' Configura los parámetros POST
    Dim postData As String
    postData = "{""authentication"":{""apiKey"":""" & apiKey & """,""propKey"":""" & propKey & """},""bookings"":{""fromDate"":""" & fromDate & """,""toDate"":""" & toDate & """}}"

    ' Crear objeto HTTP
    Set http = CreateObject("MSXML2.XMLHTTP")

    ' Abrir conexión
    http.Open "POST", url, False
    http.setRequestHeader "Content-Type", "application/json"
    http.send postData

    ' Obtener respuesta
    response = http.responseText

    ' Mostrar respuesta para debug
    Debug.Print response
    MsgBox response

    ' Parsear JSON
    On Error GoTo ErrorHandler
    Set json = JsonConverter.ParseJson(response)
    On Error GoTo 0

    ' Establecer hoja de trabajo
    Set ws = ThisWorkbook.Sheets("Sheet1")
    ws.Cells.Clear

    ' Escribir encabezados
    headers = Array("bookId", "roomId", "status", "firstNight", "lastNight", "numAdult", "numChild", "guestFull", "guestEmail", _
                    "guestPhone", "guestCountry", "guestCountry2", "guestComments", "notes", "flagColor", "price", "tax", _
                    "commission", "rateDescription", "refererEditable", "apiReference", "propId", "ownerId", "bookingTime", _
                    "modified", "cancelTime")

    For i = LBound(headers) To UBound(headers)
        ws.Cells(1, i + 1).Value = headers(i)
    Next i

    ' Escribir datos
    i = 2
    Dim booking As Dictionary
    On Error Resume Next
    For Each booking In json
        If Not booking.Exists("bookId") Then
            GoTo NextBooking
        End If

        Dim j As Integer
        For j = LBound(headers) To UBound(headers)
            On Error Resume Next
            If headers(j) = "status" Then
                ws.Cells(i, j + 1).Value = TraducirStatus(CStr(booking(headers(j))))
            ElseIf headers(j) = "guestFull" Then
                ws.Cells(i, j + 1).Value = booking("guestTitle") & " " & booking("guestFirstName") & " " & booking("guestName")
            Else
                ws.Cells(i, j + 1).Value = booking(headers(j))
            End If
            On Error GoTo 0
        Next j
        ' Cambiar el color de fondo de la celda con el nombre del huésped
        If booking.Exists("flagColor") Then
            Dim color As String
            color = booking("flagColor")
            If color <> "" Then
                ws.Cells(i, Application.Match("guestFull", headers, 0)).Interior.color = RGB(CLng("&H" & Mid(color, 1, 2)), CLng("&H" & Mid(color, 3, 2)), CLng("&H" & Mid(color, 5, 2)))
            End If
        End If
        i = i + 1
NextBooking:
    Next booking
    On Error GoTo 0

    ' Limpiar
    Set http = Nothing
    Set json = Nothing
    Exit Sub

ErrorHandler:
    MsgBox "Error parsing JSON: " & Err.Description
    Debug.Print "Error parsing JSON: " & Err.Description
End Sub

Function TraducirStatus(status As String) As String
    Select Case CInt(status)
        Case 0
            TraducirStatus = "Cancelada"
        Case 1
            TraducirStatus = "Confirmada"
        Case 2
            TraducirStatus = "Nueva"
        Case 3
            TraducirStatus = "Solicitud"
        Case 4
            TraducirStatus = "Bloqueada"
        Case 5
            TraducirStatus = "Consulta"
        Case Else
            TraducirStatus = "Desconocido"
    End Select
End Function


